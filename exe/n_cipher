#!/usr/bin/env ruby

require 'n_cipher'
require 'thor'

class NCipherCLI < Thor
  map %w(-v --version) => :version
  class_option :seed, :type => :string
  class_option :delimiter, :type => :string

  sub_commands = {'encode' => ['encode <STRING>', '文字列をN暗号化'],
                  'decode' => ['decode <STRING>', 'N暗号文字列を復号化']}

  sub_commands.each_pair do |command, (synopsis, description)|
    desc(synopsis, description)
    define_method(command) do |string = nil|
      begin
        string ||= $stdin.read.chomp
        seed = options[:seed] || ENV['NCIPHER_SEED'] || 'にゃんぱす'
        delimiter = options[:delimiter] || ENV['NCIPHER_DELIMITER'] || '〜'
        STDOUT.puts NCipher.send(command, string, seed: seed, delimiter: delimiter)
      rescue => e
        STDERR.puts "#{__FILE__}: #{e.message}"
        exit 1
      end
    end
  end

  desc 'version', 'Print version'
  def version
    STDOUT.puts NCipher::VERSION
    exit 0
  end
end

NCipherCLI.start
